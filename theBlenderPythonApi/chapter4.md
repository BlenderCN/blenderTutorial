# 建模和渲染的主题

本章详细介绍了3D建模和渲染中的特定主题。虽然非常一般，但在我们构建更高级的工具和插件时，
这些主题在第5章和文本的其余部分中变得非常重要。读者将了解3D艺术家，
游戏开发人员和渲染软件工程师常见的许多实用程序和陷阱。有了这些知识，
读者将能够更好地满足这些专业人员在脚本和插件开发方面的需求。

## 指定一个3D模型

3D模型是复杂的数字资源，可以由许多不同的组件组成。在我们通常认为网格是构成资源形状的最重要结构的地方，
网格由面构成，其由由索引排列的顶点组成。网格可以包含法线向量或法线，可以使用顶点或面指定，具体取决于文件格式。
当我们在摘要中引用这些术语时，我们通常会讨论3D建模主题，而不是在Blender中专门定义它们。

我们开始讨论3D模型，纯粹是网格，包括顶点，索引，面和法线。
从那里，我们讨论3D模型的高级和特定功能，作为我们对网格讨论的扩展。

### 指定网格

出于本章的目的，我们认为基本网格是由其面和法向量定义的。请参阅上述组件的以下定义：

1。顶点是指定三维空间中位置的实值三元组，通常表示为(x,y,z)。由于我们讨论的原因，
通常会在指定3D网格的文件中多次指定相同的点。在3D建模中，z轴或y轴最常用于表示垂直轴。在Blender中，z轴是垂直轴。
我们将在整个文本中使用此格式。

2。指数是正整数三元组，它使用一系列顶点指定面，通常表示为(i,j,k)。给定索引为1,...,N的N个顶点的列表，
3D空间中的面可以由1,...,N中的任意三个唯一整数三元组指定。
这个概念在逻辑上非常自然地扩展到允许我们通过重用预先指定的顶点来定义网格。由于我们解释的原因，
整数的顺序对于确定面部可见的方向很重要。索引重用元组值的概念通常会扩展到其他元组，例如法线和UV。

3。面由引用三个顶点的整数三元组索引确定。根据我们的定义，我们自然会得出这样的事实：
3D空间中的三顶点面需要总共九个实值数据点。重要的是要注意3D空间中的面只能在单个方向看到。
给定旋转相机和3D空间中的单个面部，用户将进能够从单个方向观看面部。从另一个方向看，面部将显示完全透明。
这是我们将学习控制的许多3D渲染器的原生和预期行为。请注意，默认情况下，Blender不会显示此单向行为，
但在导出为其他文件格式时，Blender将不会自动控制或更正此行为。

4。法线向量是实值三元组，用于定义网格如何与场景中的灯光和摄像机进行交互。目前，我们只关注法线，
因为它们被直接分配到点而不是3D艺术家可能已经熟悉的法线贴图。顾名思义，
在假设法线矢量垂直于其正在照射的面部的情况下，场景中的相机和照明与网格相互作用。
这并不总是一个微不足道的问题，正如我们将在我们的立方体示例中看到的那样。
法线向量还会影响面部可见的方向以及面部透明的方向，如面部定义所述。

### 指定纹理

3D模型中纹理的目的是将2D图像映射到3D表面上，通常使用现有的2D艺术资源。我们用于此的坐标约定是(u,v)坐标系。
在数学的其他领域，当讨论3D表面的2D投影时，我们通常使用(u,v)坐标系来清楚地表示我们在与(x,y,z)坐标系分开的空间中工作。

纹理坐标非常直观。如果我们想在矩形表面上拉伸图像，
我们指定uv坐标列表[(0.0,0.0),(1.0,0.0),(0.0,1.0),(1.0,1.0)]来拉伸整个图像，面朝上，从左到右，
在我们正在看的表面上。这假设我们模型中的坐标1到4表示从我们的角度看表面的左下角，右下角，左下角和右上角坐标。
有关此香草纹理方案的示例，请参见图4-1。

图4-1

![](https://github.com/BlenderCN/blenderTutorial/blob/master/mDrivEngine/4-1.png?raw=true)

如果我们想要在表面上拉伸，缩小或复制图像，我们只需通过适当的因子调整uv坐标。例如，在立方体表面上将图像平铺三次，
我们输入uv坐标[(0.0),(3.0,0.0),(0.0,3.0),(3.0,3.0)]。有关平铺纹理的示例，请参见图4-2。

图4-2

![](https://github.com/BlenderCN/blenderTutorial/blob/master/mDrivEngine/4-2.png?raw=true)

在第8章之前，我们不会通过Blender的Python API使用纹理，但是当我们讨论3D模型和文件格式时，纹理的uv坐标的概念很重要。

## 常见文件格式

我们首先列出常见的文件格式并解释它们各自的优点和用途。我们在本章开头将这些格式与我们对3D对象的定义结合使用，
以进一步说明这些概念。

### Wavefront(.obj and mtl)

Wavefront几何(.obj)和材料(.mtl)规范格式协同工作以指定网格和纹理。它们的编写方式使.obj文件可以独立存在以仅指定几何。
.obj文件非常简单易懂，非常适合用作讨论3D对象形状的标准符号。

有关带有.obj格式的xy平面中的简单方形的示例，请参见清单4-1。我们将不再详细解释.mtl文件，因为它与我们对渲染概念的讨论不太相关。

清单4-1。.obj格式的简单方形。

    # Use hashes to leave comments in .obj files
    # The 'o' tag is used to name objects
    # all data following an 'o' tag is considered
    # to have this name until another name is entered o MySimpleFace
    
    # Vertices are entered with the 'v' tag as
    # space-delimited(x,y,z) tuples
    v -1.00 0.00 1.00
    v 1.00 0.00 1.00
    v -1.00 0.00 -1.00
    v 1.00 0.00 -1.00
    
    # Texture coordinate are entered with the 'vt' tag as
    # space-delimited(u,v) tuples,between 0 and 1
    vt 0.00 1.00
    vt 1.00 1.00
    vt 0.00 0.00
    vt 1.00 0.00
    
    # Normal vectors are entered with the 'vn' tag as
    # space-delimited(x,y,z) tuples,can be normal vectors if desired
    vn 0.0000 1.0000 0.0000
    
    # Indices are entered with the 'f' (for face) tag as
    # space-delimited triplets of v,vt,and vn indices as
    # f v_i/vt_i/vn_i v_j/vt_j/vn_j v_k/vt_k/vn_k
    # Faces can have any number(three or more) coplanar point
    f 2/2/1 3/3/1 1/1/1
    f 2/2/1 4/4/1 3/3/1
    
    # Alternatively,the faces section for this face can be
    # written as a single coplanar quadrilateral:
    f 1/1/1 2/2/1 4/4/1 3/3/1
    
    # Alternatively,the texture coordinates can be
    # excluded with double slashes
    f 1//1 2//1 4//1 3//1
    
我们在清单4-1中看到.obj文件格式的规范，用于具有以下特征的简单面：  

1。两个单位长两个单位宽

2。以原点为中心，法线向量沿z轴向上

3。一些纹理沿正x轴和y轴定向。

我们将在以下实例中看到.obj格式与其他格式相比相当成熟且灵活。

### STL(STereoLithography)

STL文件格式通常由工程师和CAD软件使用。与.obj格式相比，它是冗长的，但带有二进制规范以补偿其低效率。
大多数STL出口商(包括Blender)默认使用二进制规范，在没有特殊软件的帮助下使文件难以辨认。
我们只在本文中使用文件的文本格式。

有关我们的简单面，请参见清单4-2,如清单4-1所示，以STL格式指定。STL支持法线向量和面，但不使用索引或支持纹理坐标。
如清单4-2所示，我们必须指定两次相同法向量和总共六个顶点来指定STL中的四边形面。此外，STL不支持超过三个共面点的规范。
奇怪的是，在大多数3D文件格式允许将法向量分配给点的情况下，STL仅允许在面部级别上分配法向量。

结构相当不言自明。每个侧面法线x y z初始化一个面，然后每个外部loop-endloop对保持面的有序顶点。
每个顶点在循环内指定为顶点x y z。

清单4-2。STL格式的简单面(文本格式)

    solid MyFace
      facet normal    0.0     0.0     1.0
        outter loop     
          vertex     -1.0    -1.0     0.0
          vertex      1.0    -1.0     0.0
          vertex     -1.0     1.0     0.0
        endloop
      endfacet
      facet normal    0.0     0.0     1.0
        outer loop
          vertex      1.0    -1.0     0.0
          vertex      1.0     1.0     0.0
          vertex     -1.0     1.0     0.0
        endloop       
      endfacet
    endsolid Myface

### PLY(多边形文件格式）

此文件格式由斯坦福大学构建，用于处理3D扫描软件。它与C语言有着密切的关系，并且有很多开源工具可以直接使用它。
我们对3D网格格式的讨论应该开始重复。PLY格式本质上是.obj的精简版本，其中包含仅支持顶点和面的附加元数据，
而不支持法线矢量或纹理。

标题中的一些元数据是相当标准的，包括ply，格式和属性标签。我们不会深入研究属性标签。只要知道他们引用C级数据类型与现有C库合作。
元素顶点和元素面线分别指定文件的多少行引用顶点和面。在我们的例子中，我们有元素顶点4和元素面1,因为我们指定了一个面。
值得注意的是，PLY格式支持超过三个共面点的规范。

有关面部的示例，请参见清单4-3。

清单4-3。PLY格式的简单面。

    ply
    format ascii 1.0
    comment specifies a simple face
    element vertex 4
    property float32 x
    property float32 y
    property float32 z
    element face 1
    property list uint8 int32 vertex_indices
    end_header
    -1 -1 0
    1 -1 0
    1 1 0
    -1 1 0
    4 1 0 3 2
    
### Blender(.blend) Files and Interchange Formats

特别死根据前面的例子，Blender的原生文件格式和内存数据结构非常复杂。Blender支持对具有非共面顶点的顶点，
边和面进行操作。一直以来，Blender管理与纹理，声音，动画，装备，灯光等相关的复杂数据。这些.blend文件以二进制表示，
并不是人类可读的。值得庆幸的是，我们可以通过Python API安全地继续访问和操作Blender的内部数据。

.blend文件与前面提到的.obj,.stl和.ply文件之间的复杂性和完整性的差异是有意的。
虽然所有这些文件都以某种方式表示3D模型，但.blend文件并非设计为在其他3D建模套件中导出和导入。
上面讨论的文件格式称为交换格式，这意味着它们有意地表示可以在建模软件和渲染器之间轻松移植的通用且定义明确的特征子集。 

虽然开发人员过去曾尝试在3DS Max，AutoCAD和Maya以及Blender等特定3D建模套件之间创建完整的互操作性，
但它们必然无法捕获任何一个套件支持的所有功能。因此，我们采用交换格式来保持通信和期望的一致性。

## 基本对象的最小规范

重要的是讨论3D模型规范背后的一些理论，以便我们可以评估各种3D文件格式的效率和功能。
我们将参考上一节中讨论的文件格式来帮助说明。

### 立方体的定义

立方体是一个三维物体，有六个面由相等长度的正方形组成。一个立方体包含6个面，12个边和8个顶点。
立方体的正方形面可以被视为两个直角三角形的组合，其腿长等于方形长度。请注意，
3D空间中的任何对象都可以通过浮点和整数值定义，其中浮点数指定3D空间中的位置和方向，整数指定相关索引。
3D对象还需要法线矢量，可以将其分配给顶点或面。

我们将使用此信息构建详细说明不同3D规范模式的数据密度的表。

### 天真的规范

为了天真地指定3D立方体，我们将彼此独立地指定6*2=12个所需三角形面中的每一个，并为每个点指定独立的法向量。
这应该导致12*3=36个顶点和12*3=36个法向量。我们可以用.obj格式编写，如清单4-4所示。
图4-3显示了此模型的数据结构的可视化。

这个模型的天真定义如下：

1。无需重复顶点坐标。

2。无需重复的法线矢量方向。

3。不必使用顶点法线代替面法线。

清单4-4。天真定义的立方体。

    o NativeCube
    
    # (36*3) + (36*3) = 216 floats
    # (12*3) + (12*3) = 72 integers
    v 1.000000 -1.000000 -1.000000
    v 1.000000 -1.000000 1.000000
    v -1.000000 -1.000000 1.000000
    v -1.000000 -1.000000 -1.000000
    v 1.000000 1.000000 -0.999999
    v 0.999999 1.000000 1.000001
    v -1.000000 1.000000 1.000000
    v -1.000000 1.000000 -1.000000
    v 1.000000 -1.000000 -1.000000
    v 1.000000 -1.000000 -1.000000
    v 1.000000 -1.000000 1.000000
    v 1.000000 -1.000000 1.000000
    v -1.000000 -1.000000 -1.000000
    v -1.000000 -1.000000 -1.000000
    v 1.000000 1.000000 -0.999999
    v 1.000000 1.000000 -0.999999
    v -1.000000 -1.000000 1.000000
    v -1.000000 -1.000000 1.000000
    v 0.999999 1.000000 1.000001
    v 0.999999 1.000000 1.000001
    v -1.000000 1.000000 1.000000
    v -1.000000 1.000000 1.000000
    v -1.000000 1.000000 -1.000000
    v -1.000000 1.000000 -1.000000
    v 1.000000 -1.000000 -1.000000
    v -1.000000 -1.000000 1.000000
    v 0.999999 1.000000 1.000001
    v -1.000000 1.000000 -1.000000
    v 1.000000 -1.000000 -1.000000
    v 1.000000 -1.000000 1.000000
    v 1.000000 1.000000 -0.999999
    v -1.000000 -1.000000 1.000000
    v -1.000000 -1.000000 1.000000
    v 0.999999 1.000000 1.000001
    v -1.000000 1.000000 -1.000000
    v -1.000000 1.000000 -1.000000
    
    vn 0.0000 -1.0000 0.0000
    vn 0.0000 1.0000 0.0000
    vn 1.0000 -0.0000 0.0000
    vn 0.0000 -0.0000 1.0000
    vn -1.0000 -0.0000 -0.0000
    vn 0.0000 0.0000 -1.0000
    vn 0.0000 -1.0000 0.0000
    vn 0.0000 1.0000 0.0000
    vn 1.0000 -0.0000 0.0000
    vn 0.0000 -0.0000 1.0000
    vn -1.0000 -0.0000 -0.0000
    vn 0.0000 0.0000 -1.0000
    vn 0.0000 -1.0000 0.0000
    vn 0.0000 1.0000 0.0000
    vn 1.0000 -0.0000 0.0000
    vn 0.0000 -0.0000 1.0000
    vn -1.0000 -0.0000 -0.0000
    vn 0.0000 0.0000 -1.0000
    vn 0.0000 -1.0000 0.0000
    vn 0.0000 1.0000 0.0000
    vn 1.0000 -0.0000 0.0000
    vn 0.0000 -0.0000 1.0000
    vn -1.0000 -0.0000 -0.0000
    vn 0.0000 0.0000 -1.0000
    vn 0.0000 -1.0000 0.0000
    vn 0.0000 1.0000 0.0000
    vn 1.0000 -0.0000 0.0000
    vn 0.0000 -0.0000 1.0000
    vn -1.0000 -0.0000 -0.0000
    vn 0.0000 0.0000 -1.0000
    vn 0.0000 -1.0000 0.0000
    vn 0.0000 1.0000 0.0000
    vn 1.0000 -0.0000 0.0000
    vn 0.0000 -0.0000 1.0000
    vn -1.0000 -0.0000 -0.0000
    vn 0.0000 0.0000 -1.0000
    
    f 9//1 17//13 13//25
    f 24//2 20//14 16//26
    f 15//3 12//15 10//27
    f 6//4 18//16 2//28
    f 3//5 23//17 14//29
    f 1//6 8//18 5//30
    f 29//7 11//19 32//31
    f 36//8 22//20 34//32
    f 31//9 19//21 30//33
    f 27//10 21//22 33//34
    f 26//11 7//23 35//35
    f 25//12 4//24 28//36
    
换句话说，天真的3D规范不会通过将每个面部视为完全独立的三角形来重复使用顶点或法线。此外，
在诸如立方体的简单情况下使用顶点法线而不是面法线会增加浪费。这种模式将从以下方面收益：

1。删除重复的顶点。

2。将三角形面指定为方形面。

3。删除重复的法线和/或使用面法线

4。正确利用索引来组织顶点和法线。

值得注意的是，这种格式与.stl格式具有相同的复杂程度，禁止STL使用面法线。

接下来我们将展示非重复顶点和法线如何在不增加复杂性的情况下缩小模型大小

### 使用索引共享顶点和法线

清单4-5显示了一个包含共享顶点和法线的.obj文件。当文件能够正确使用索引而不是重复浮点数据时，
我们只需要总共42个浮点数。在下一个示例中，我们将利用共面曲面来减少整数的总数。在视觉上，
这些数据看起来与图4-3中的相同，我们只减少了浮点数据中的重复。

清单4-5具有共享顶点和法线的立方体

    o SharingCube
    
    # (8*3) + (6*3) = 42 floats
    # (12*3) + (12*3) = 72 integers

    v 1.000000 -1.000000 -1.000000
    v 1.000000 -1.000000 1.000000
    v -1.000000 -1.000000 1.000000
    v -1.000000 -1.000000 -1.000000
    v 1.000000 1.000000 -0.999999
    v 0.999999 1.000000 1.000001
    v -1.000000 1.000000 1.000000
    v -1.000000 1.000000 -1.000000    

    vn 0.0000 -1.0000 0.0000
    vn 0.0000 1.0000 0.0000
    vn 1.0000 -0.0000 0.0000
    vn 0.0000 -0.0000 1.0000
    vn -1.0000 -0.0000 -0.0000
    vn 0.0000 0.0000 -1.0000

    f 1//1 3//1 4//1
    f 8//2 6//2 5//2
    f 5//3 2//3 1//3
    f 6//4 3//4 2//4
    f 3//5 8//5 4//5
    f 1//6 8//6 5//6
    f 1//1 2//1 3//1
    f 8//2 7//2 6//2
    f 5//3 6//3 2//3
    f 6//4 7//4 3//4
    f 3//5 7//5 8//5
    f 1//6 4//6 8//5

图4-3

![](https://github.com/BlenderCN/blenderTutorial/blob/master/mDrivEngine/4-3.png?raw=true)    
